     1                                  USE32
     2                                  
     3                                  SECTION .kernel32
     4                                  
     5                                  EXTERN __DATA_VMA
     6                                  EXTERN limpiar_buffer
     7                                  EXTERN msg_bienvenida_VGA
     8                                  EXTERN __VGA_VMA
     9                                  EXTERN __VGA_PHY
    10                                  EXTERN limpiar_VGA
    11                                  ;--------------GLOBAL----------------------
    12                                  GLOBAL kernel32_code_size
    13                                  GLOBAL kernel32_init
    14                                  GLOBAL memoria_buffer_reservada
    15                                  GLOBAL contador_timer
    16                                  GLOBAL resultado_promedio
    17                                  GLOBAL dir_lineal_page_fault
    18                                  GLOBAL error_code_PF
    19                                  GLOBAL dir_phy_dinamica
    20                                  GLOBAL page_fault_msg
    21                                  GLOBAL page_fault_msg_2
    22                                  GLOBAL page_fault_msg_3
    23                                  GLOBAL page_fault_msg_4
    24                                  GLOBAL page_fault_msg_5
    25                                  GLOBAL page_fault_msg_6
    26                                  GLOBAL paginas_creadas
    27                                  GLOBAL Stack_aux
    28                                  GLOBAL TSS_aux
    29                                  GLOBAL CR3_aux
    30                                  kernel21_code_size EQU kernel32_end-kernel32_init
    31                                  ;---------EQU-----------------------------
    32                                  CANTIDAD_DATOS  EQU 10
    33                                  LONG_BUFFER     EQU 16
    34                                  
    35                                  kernel32_init:
    36                                      ;xchg bx,bx              ; Llegue al kernel
    37 00000000 31C0                        xor eax,eax
    38 00000002 31DB                        xor ebx,ebx
    39 00000004 31C9                        xor ecx,ecx
    40 00000006 31D2                        xor edx,edx
    41                                      ; -> Inicializo el buffer del teclado.
    42 00000008 55                          push    ebp
    43 00000009 89E5                        mov     ebp, esp
    44 0000000B 68[00000000]                push dword memoria_buffer_reservada
    45 00000010 E8(00000000)                call limpiar_buffer                     
    46 00000015 C9                          leave
    47                                      ; -> Escribo la pantalla con mensaje fijo.
    48 00000016 55                          push    ebp
    49 00000017 89E5                        mov     ebp, esp
    50 00000019 68[00000000]                push    __VGA_VMA
    51 0000001E E8(00000000)                call msg_bienvenida_VGA                     
    52 00000023 C9                          leave
    53                                  
    54                                      ;xchg bx,bx              
    55                                  
    56                                  main:
    57 00000024 F4                          hlt                     ; CPU en HALT aguardando por interrupciones
    58 00000025 EBFD                        jmp main 
    59                                  
    60                                  guard:
    61 00000027 F4                          hlt                                     
    62 00000028 EBFD                        jmp guard
    63                                  
    64                                  kernel32_end:
    65                                      
    66                                  
    67                                  ;-------- VARIABLES DE DATOS PARA PROPOSITO GENERAL----
    68                                  SECTION .data_kernel
    69                                  variables_globales:
    70 00000000 <res 00000013>              memoria_buffer_reservada    resb 19             ; Reservo para buffer[0-16] + head[17] + tail[18] + cantidad[19] 
    70          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    71                                  
    72 00000013 <res 00000001>              contador_timer              resb 1              ; Contador del timer
    72          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    73                                  
    74 00000014 <res 00000008>              resultado_promedio          resq 1              ; Resultado del promedio cada 500ms de los dígitos en tabla.
    74          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    75                                  
    76 0000001C <res 00000004>              dir_lineal_page_fault       resd 1              ; Dir. Lineal que produjo una Page Fault Exception.
    76          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    77                                  
    78 00000020 <res 00000004>              error_code_PF               resd 1              ; Código de error del #PF
    78          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    79                                  
    80 00000024 0000000A                    dir_phy_dinamica            dd 0x0A000000       ; Dir. Phy. dinámica para salvar el #PF
    81                                  
    82 00000028 <res 00000004>              paginas_creadas             resd 1              ; Cantidad de páginas creadas en el #PF .
    82          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    83                                  
    84 0000002C <res 00000004>              TSS_aux                     resd  1               ; TSS auxiliar para guardar o leer contextos en memoria
    84          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    85                                  
    86 00000030 <res 00000004>              CR3_aux                     resd  1               ; CR3 auxiliar para guardar o leer contextos de memoria
    86          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    87                                  
    88 00000034 <res 00000030>              Stack_aux                   resb 48             ; Stack para leer contexto de memoria 
    88          ******************       warning: uninitialized space declared in non-BSS section `.data_kernel': zeroing
    89                                  mensajes_error:
    90 00000064 2D2D2D2D2D50414745-         page_fault_msg              db "-----PAGE FAULT-----",0
    90 0000006D 204641554C542D2D2D-
    90 00000076 2D2D00             
    91 00000079 4469722E20564D4120-         page_fault_msg_2            db "Dir. VMA = 0x",0
    91 00000082 3D20307800         
    92 00000087 4572726F7220436F64-         page_fault_msg_3            db "Error Code: ",0
    92 00000090 653A2000           
    93 00000094 506167696E6163696F-         page_fault_msg_4            db "Paginacion OFF. Se puede paginar con VMA del CR2",0
    93 0000009D 6E204F46462E205365-
    93 000000A6 207075656465207061-
    93 000000AF 67696E617220636F6E-
    93 000000B8 20564D412064656C20-
    93 000000C1 43523200           
    94 000000C5 506167696E6163696F-         page_fault_msg_5            db "Paginacion exitosa.",0
    94 000000CE 6E20657869746F7361-
    94 000000D7 2E00               
    95 000000D9 2350462048616E646C-         page_fault_msg_6            db "#PF Handler - Paginas de 4K creadas: ",0
    95 000000E2 6572202D2050616769-
    95 000000EB 6E617320646520344B-
    95 000000F4 20637265616461733A-
    95 000000FD 2000               
